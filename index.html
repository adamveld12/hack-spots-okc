<html>
	<head>
		<title>OKC Hack Spots</title>
		<meta charset='utf-8'>
		<script type="text/javascript" src="js/vendor/ICanHaz.js"></script>
		<script type="text/javascript" src='http://api.tiles.mapbox.com/mapbox.js/v1.4.0/mapbox.js'></script>
		<script type="text/javascript" src='js/vendor/jquery.js '></script>
		<script type="text/javascript" src='js/vendor/tabletop1.3.4.js'></script>
		<script type="text/javascript" src='js/vendor/sheetsee.js'></script>
		<script type="text/javascript" src='js/vendor/leaflet.markercluster.js'></script>
		<link rel="shortcut icon" href="https://raw.github.com/jlord/hack-spots/master/favico.png"/>

		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<link rel='stylesheet' href='http://api.tiles.mapbox.com/mapbox.js/v1.4.0/mapbox.css'  />
		<link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic'>
		<link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Amatic+SC:400,700'>
		<link rel="stylesheet" href="css/MarkerCluster.css" />
		<link rel="stylesheet" href="css/MarkerCluster.Default.css" />

		<!-- <link media="screen" rel="stylesheet" type="text/css" href="css/style.css"> -->
		<!-- <link media="screen" rel="stylesheet" type="text/css" href="css/site.css"> -->
		<link media="screen" rel="stylesheet" type="text/css" href="css/main.css">
	</head>
  <body>
      <h1>OKC Hack Spots</h1>
      <div class="nav">
        <p>For all of the OKC laptop nomads</p>
        <ul>
          <li><a href="#info">About</a></li>
          <li><a href="http://jlord.github.com/sheetsee.js" target="_blank">POWERED BY SHEETSEE.JS</a></li>
          <li>Inspired by <a href="http://www.github.com/jlord/hack-spots" target="_blank">JLord's Hack Spots</a></li>
          <li><a href="http://www.github.com/adamveld12/hack-spots-okc" target="_blank">GITHUB</a></li>
          <li>
            Follow these guys:
            <a href="http://www.twitter.com/adamveld12" target="_blank">@adamveld12</a>
            <a href="http://www.twitter.com/make_nova" target="_blank">@make_nova</a>
          </li>
        </ul>
      </div>

      <div id="map"></div>

      <div id="selectedSpot"></div>

      <div id="searchbox" class="search">
        <input id="tableFilter" type="text" placeholder="filter by..">
        <span class="clear button">Clear</span> <span class="resetMap button">Reset Map</span> <span class="noMatches">No Matches</span>
      </div>

      <div class="hackspots">
        <div id="hackSpotsTable"></div>
      </div>

      <div id="info" class="container">
        <h3>Contribute!</h3>
        <div id="theNumberofSpots"></div>
        <h3>Info</h3>
        <h3>Fork-n-Go</h3>
      </div>

    <script id="hackSpotsTable" type="text/html">
      <table>
        <tr>
          <th class="tHeader">Name</th>
          <th class="tHeader">Address</th>
          <th class="">Elsewhere</th>
        </tr>
        {{#rows}}
          <tr id="{{rowNumber}}" class="spotRow">
           <td>{{name}}</td>
           <td>{{address}}</td>
           <td>
             <a class="button" href="https://maps.google.com/maps?q={{address}},Oklahoma City,Oklahoma" target="_blank">G Map</a>
             <a class="button" href="http://www.yelp.com/search?find_desc={{name}}&find_loc=Oklahoma City,Oklahoma" target="_blank">Yelp</a>
           </td>
          </tr>
          <tr class="hideRow">
            <td>wifi: {{wifipassword}}</td>
          </tr>
        {{/rows}}
      </table>
    </script>

    <script id="latestSpot" type="text/html">
        {{#rows}}
          <h4 class="fauxButton">MOST RECENT SPOT</h4>
          <h2>{{name}}</h2>
          <p class="colorText">{{address}}, {{postcode}}<p>
          <ul>
            <li><span class="category">Wifi Name:</span> {{wifiname}}</li>
            <li><span class="category">Wifi:</span> {{wifipassword}}</li>
            <li><span class="category">Outlets:</span> {{outlets}}</li>
            <li><span class="category">Couch:</span> {{couch}}</li>
            <li><span class="category">Large Table:</span> {{largetable}}</li>
            <li><span class="category">Outdoor Seating:</span> {{outdoorseating}}</li>
            <li><span class="category">Brewing:</span> {{brewing}}</li>
            <li>
              <span class="category">Contributed By:</span> <a href="http://www.twitter.com/{{contributerstwitter}}" target="_blank">@{{contributerstwitter}}</a>
            </li>
          </ul>
          <ul>
            <li><a href="https://maps.google.com/maps?q={{address}},Oklahoma City,Oklahoma" target="_blank">View in Google Maps</a></li>
            <li><a href="http://www.yelp.com/search?find_desc={{name}}&find_loc=Oklahoma City,Oklahoma" target="_blank">Find on Yelp</a></li>
          </ul>
        {{/rows}}
    </script>

    <script id="theNumberofSpots" type="text/html">
      <p><strong><span class="red-text">{{numberOfSpots}}</span> hack spots strong!</p>
    </script>

    <script id="popUps" type="text/html">
      <h2>{{ name }}</h2>
    </script>

    <script id="selectedSpot" type="text/html">
      {{#rows}}
        <h4 class="fauxButton">SELECTED SPOT</h4>
        <h2>{{name}}</h2>
        <p class="colorText">{{address}}, {{postcode}}<p>
        <ul>
          <li><span class="category">Wifi Name:</span> {{wifiname}}</li>
          <li><span class="category">Password:</span> {{wifipassword}}</li>
          <li><span class="category">Outlets:</span> {{outlets}}</li>
          <li><span class="category">Couch:</span> {{couch}}</li>
          <li><span class="category">Large Table:</span> {{largetable}}</li>
          <li><span class="category">Outdoor Seating:</span> {{outdoorseating}}</li>
          <li><span class="category">Details:</span> {{details}}</li>
        </ul>
        <ul>
          <li><a href="https://maps.google.com/maps?q={{address}},Oklahoma City,Oklahoma" target="_blank">View in Google Maps</a></li>
          <li><a href="http://www.yelp.com/search?find_desc={{name}}&find_loc=Oklahoma City,Oklahoma" target="_blank">Find on Yelp</a></li>
        </ul>
      {{/rows}}
    </script>

    <script type="text/javascript">
      document.addEventListener('DOMContentLoaded', function() {
        var gData
        var URL = "1IP_0vxifIw6cW6UP-vH0l-GvWBPA1NDG7j4cT17AKKs"
        Tabletop.init( { key: URL, callback: showInfo, simpleSheet: true } )
      })

      // so long, so messy

      function showInfo(gData) {
        gData
        // make the table, and the search bar
        Sheetsee.makeTable(gData, "#hackSpotsTable")
        Sheetsee.initiateTableFilter(gData, "#tableFilter", "#hackSpotsTable")

        // when someone clicks on a row, highlight it and
        // re-center the map
        $('.spotRow').live("click", function(event) {
          $('.spotRow').removeClass("selectedRow")
          var rowNumber = $(this).closest("tr").attr("id")
          $('#' + rowNumber).addClass("selectedRow")
          var dataElement = Sheetsee.getMatches(gData, rowNumber, "rowNumber")
          var selectedSpot = ich.selectedSpot({
            rows: dataElement
          })
          $('#latestSpot').css("display", "none")
          $('#selectedSpot').html(selectedSpot).css("display", "inline")
          var selectedCoords = [dataElement[0].lat, dataElement[0].long]
          matchGeoJSONbyRowNumber(rowNumber, geoJSON, gData, "#FF4646")
          var markerLayer = Sheetsee.addMarkerLayer(geoJSON, map, 13)
          addPopups(map, markerLayer)
          map.panTo(selectedCoords, 13)
        })

        // so that the first map and info that loads
        // is complete and doesn't show rows that are
        // actively being edited by folk
        function findLatestCompleteSpot(data) {
          var latestCompleteSpot = []
          var startWithLatestRow = data.reverse()
          startWithLatestRow.forEach(function(row){
            if (row.lat && row.long && row.name && row.address)
              latestCompleteSpot.push(row)
          })
          return latestCompleteSpot[0]
        }

        // find the latest spot with the most important
        // info filled in (to prevent map breaking if
        // someone is currently editing spreadsheet)
        var theLatestSpot = findLatestCompleteSpot(gData)
        var latestSpot = ich.latestSpot({
           rows: theLatestSpot
        })
        $('#latestSpot').html(latestSpot)

        function highlightLastMarker(geoJSON, highlightColor) {
          geoJSON[0].properties["marker-color"] = highlightColor
          return geoJSON
        }

        // create geoJSON with coordinates and other
        // useful bits from the original data
        var optionsJSON = ["name", "address", "city", "rowNumber"]
        var geoJSONnoHL = Sheetsee.createGeoJSON(gData, optionsJSON)
        // change the color of the most recently added spot's marker
        var geoJSON = highlightLastMarker(geoJSONnoHL, "#FF4646")

        // create map, tilelayer (map background), markers and popups
        var map = Sheetsee.loadMap("map")
        Sheetsee.addTileLayer(map, 'examples.map-20v6611k')
        var markerLayer = Sheetsee.addMarkerLayer(geoJSON, map, 13)
        addPopups(map, markerLayer)

        // design the popups to have the content and
        // interactions that we want
        function addPopups(map, markerLayer) {
          markerLayer.eachLayer(function(marker) {
            var popupContent = ich.popUps(marker.feature.opts)
            marker.bindPopup(popupContent, {closeButton: false,})
          })
          markerLayer.on('click', function(e) {
          // clear any selected rows
          $('.spotRow').removeClass("selectedRow")
          // get row number of selected marker
          var rowNumber = e.layer.feature.opts.rowNumber.toString()
          // find that row in the table and make consider it selected
          $('#' + rowNumber).addClass("selectedRow")
          // using row number, find that marker in the geoJSON, give it
          // the selected marker color
          matchGeoJSONbyRowNumber(rowNumber, geoJSON, gData, "#FF4646")
         //  var markerLayer = Sheetsee.addMarkerLayer(geoJSON, map, 13)
          // addPopups(map, markerLayer)
          // using row number, get the data for the selected spot
          var dataElement = Sheetsee.getMatches(gData, rowNumber, "rowNumber")
          // take those details and re-write the selected spot section
          var selectedSpot = ich.selectedSpot({
            rows: dataElement
          })
          $('#latestSpot').css("display", "none")
          $('#selectedSpot').html(selectedSpot).css("display", "inline")
          })
        }

        $('.resetMap').click(function() {
          $('.spotRow').removeClass("selectedRow")
          markerLayer = Sheetsee.addMarkerLayer(geoJSON, map, 13)
          addPopups(map, markerLayer)
          $('#latestSpot').css("display", "inline")
          $('#selectedSpot').css("display", "none")
        })

        // find total number of spots added
        var numberOfSpots = gData.length
        var theNumberofSpots = ich.theNumberofSpots({
          numberOfSpots: numberOfSpots
        })
        $('#theNumberofSpots').html(theNumberofSpots)

        function matchGeoJSONbyRowNumber(rowNumber, geoJSON, gdata, highlightColor) {
          geoJSON.forEach(function (d) {
            if (d.properties["marker-color"] === highlightColor) {
              var origColor = gData[0].hexcolor
              d.properties["marker-color"] = origColor
            }
            for (var key in d.opts) {
              var value = d.opts[key].toString().toLowerCase()
              if (key === 'rowNumber' && value.match(rowNumber.toString().toLowerCase())) {
                d.properties["marker-color"] = highlightColor
                return geoJSON
              }
            }
          })
        }

    }

    </script>
  </body>
</html>
